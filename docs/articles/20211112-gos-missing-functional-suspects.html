<!DOCTYPE html>
<html lang="en">
  <head>
    <title>dbks - Go's Missing Functional Suspects</title>
   	<meta name="description" content="Go's Missing Functional Suspects" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <meta content="utf-8" http-equiv="encoding" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/github.min.css" />
    <link rel="stylesheet" href="/s/style.css" />
  </head>
  <body>
    <div id="title">
      <a href="/"><img alt="dbks logo" src="/i/dbks.png" /></a> <a href="/"><h1>deathbykeystroke</h1></a>
    </div>
    <div id="article">
      <h1>Go's Missing Functional Suspects</h1>
      <h6>// date:  2021-11-12</h6>
      <h6>// filed: <a href="/tags/golang.html">golang</a>, <a href="/tags/programming.html">programming</a></h6>
      <h6>// <a href="https://deathbykeystroke.com/articles/20211112-gos-missing-functional-suspects.html">perma</a></h6>
      <br/>

      <p>When you first start learning functional programming you get all
kinds of tools that challenge how you think about lists. You get things
like <code>foldl</code>, <code>foldr</code>, <code>map</code>, and
<code>filter</code>. Those things are really hard to stop using because
they're <em>very</em> concise and clear in the way they function. Let's
make a golang generator that gives us those four functions for any type
in go!</p>
<h2 id="writing-a-generator">Writing a Generator</h2>
<p>Go could have macros but it doesn't because there's no precompiler.
Instead of a precompiler they wrote code that does what macros do but
you have to run it manually before you run your code rather than just
inlining during compilation. So let's write a generator that just spits
out a random number and then we'll modify it later so that it gives us
what we want function wise.</p>
<p>In your scratch pad project directory toss the following into a file
(<code>pkg/generators/functional.go</code>):</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">//go:build ignore</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;fmt&quot;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;math/rand&quot;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;os&quot;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;text/template&quot;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;time&quot;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> genTemplate <span class="op">=</span> <span class="st">`// Code generated by go; DO NOT EDIT.</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="st">// Generated {{ .Timestamp }}</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="st">package main</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="st">import &quot;fmt&quot;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="st">func main() {</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="st">  fmt.Printf(&quot;%d</span><span class="ch">\n</span><span class="st">&quot;, {{.Random}})</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="st">`</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>        file<span class="op">,</span> err <span class="op">:=</span> os<span class="op">.</span>Create<span class="op">(</span><span class="st">&quot;main_random.go&quot;</span><span class="op">)</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>                fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;%v&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>                os<span class="op">.</span>Exit<span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">defer</span> file<span class="op">.</span>Close<span class="op">()</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>        template<span class="op">.</span>Must<span class="op">(</span>template<span class="op">.</span>New<span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">).</span>Parse<span class="op">(</span>genTemplate<span class="op">)).</span>Execute<span class="op">(</span>file<span class="op">,</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>                Random    <span class="dt">uint64</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>                Timestamp time<span class="op">.</span>Time</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">}{</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>                rand<span class="op">.</span>Uint64<span class="op">(),</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>                time<span class="op">.</span>Now<span class="op">(),</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">})</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>What a mouthful. Don't worry, this should make what we're about to do
much easier. This generator will get modified later. You can test it
manually by doing a quick
<code>go run pkg/generators/functional.go &amp;&amp; go run main_random.go</code>
and you can clean it up by just removing the generated
<code>main_random.go</code> file.</p>
<p>I'm going to put this generator in <code>pkg/generators</code>
directory to refer to later so we have this directory structure for the
demo:</p>
<pre><code>.
├── app.go
├── go.mod
└── pkg
    └─── generators
         └── functional.go</code></pre>
<h2 id="demo-structs">Demo Structs</h2>
<p>Now let's make a demo struct we can do something functional with. In
<code>pkg/mytypes/demo.go</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> mytypes</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">//go:generate go run ../generators/functional.go Demo string int</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Demo <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        Str <span class="dt">string</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        Num <span class="dt">int</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Now if you run <code>go generate pkg/mytypes/demo.go</code> you'll
actually see a new file <code>main_random.go</code> that will still just
spit out a random number. Let's fix that to do a filter.</p>
<h2 id="implementing-filter">Implementing Filter</h2>
<p>Focusing on <code>pkg/generators/functional.go</code> and modify a
few things. First, the package needs to be fixed so change that the
template does something more in the spirit of functional programming
(make this more practical if you're following this for real world
stuff). Let's enhance our generator to loop over arguments and use
those. Our generator should now look something like:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">//go:build ignore</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;fmt&quot;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;os&quot;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;strings&quot;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;text/template&quot;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;time&quot;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> genTemplate <span class="op">=</span> <span class="st">`{{- $m := . -}}</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="st">// Code generated by go; DO NOT EDIT.</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="st">// Generated {{ $m.Timestamp }}</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="st">// Functional receivers for {{ $m.Receiver }}</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="st">// With types {{ $m.Types }}</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="st">package {{ $m.Package }}</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="st">`</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> gen<span class="op">(</span>pkg<span class="op">,</span> name <span class="dt">string</span><span class="op">,</span> types <span class="op">[]</span><span class="dt">string</span><span class="op">)</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        file<span class="op">,</span> err <span class="op">:=</span> os<span class="op">.</span>Create<span class="op">(</span>fmt<span class="op">.</span>Sprintf<span class="op">(</span><span class="st">&quot;%s_fns.go&quot;</span><span class="op">,</span> strings<span class="op">.</span>ToLower<span class="op">(</span>name<span class="op">)))</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> err</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">defer</span> file<span class="op">.</span>Close<span class="op">()</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        funcs <span class="op">:=</span> template<span class="op">.</span>FuncMap<span class="op">{</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Title&quot;</span><span class="op">:</span> strings<span class="op">.</span>Title<span class="op">,</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        template<span class="op">.</span>Must<span class="op">(</span>template<span class="op">.</span>New<span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">).</span>Funcs<span class="op">(</span>funcs<span class="op">).</span>Parse<span class="op">(</span>genTemplate<span class="op">)).</span>Execute<span class="op">(</span>file<span class="op">,</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>                Package   <span class="dt">string</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>                Receiver  <span class="dt">string</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>                Alias     <span class="dt">string</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>                Types     <span class="op">[]</span><span class="dt">string</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>                Timestamp time<span class="op">.</span>Time</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}{</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>                pkg<span class="op">,</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>                name<span class="op">,</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>                fmt<span class="op">.</span>Sprintf<span class="op">(</span><span class="st">&quot;%ss&quot;</span><span class="op">,</span> name<span class="op">),</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>                types<span class="op">,</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>                time<span class="op">.</span>Now<span class="op">(),</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">})</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="ot">nil</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> err <span class="op">:=</span> gen<span class="op">(</span>os<span class="op">.</span>Args<span class="op">[</span><span class="dv">1</span><span class="op">],</span> os<span class="op">.</span>Args<span class="op">[</span><span class="dv">2</span><span class="op">],</span> os<span class="op">.</span>Args<span class="op">[</span><span class="dv">3</span><span class="op">:]);</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>                fmt<span class="op">.</span>Fprintf<span class="op">(</span>os<span class="op">.</span>Stderr<span class="op">,</span> <span class="st">&quot;error generating %s: %v</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> os<span class="op">.</span>Args<span class="op">[</span><span class="dv">1</span><span class="op">],</span> err<span class="op">)</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>and after <code>go generate pkg/mytypes/demo.go</code> our directory
should be:</p>
<pre><code>.
├── app.go
├── go.mod
└── pkg
    ├── generators
    │   └── functional.go
    └── mytypes
        ├── demo_fns.go
        └── demo.go
</code></pre>
<p>In the main function of the generator we're gather arguments and
giving them to the generator one by one. The line checking for a
lowercase first letter is the gatherer. It's not going to get any use
for <code>filter</code> but we will need it for <code>map</code> because
it takes one type and doesn't necessarily return that type.</p>
<p>Now we're pretty much set for life. Time to retire. Unless you're
having fun then let's do some filtering. From here it's just straight
go.</p>
<p>Our filter function should look something like this:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> AS <span class="op">[]</span>A</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>xs As<span class="op">)</span> Filter<span class="op">(</span>fn <span class="kw">func</span><span class="op">(</span>A<span class="op">)</span> <span class="dt">bool</span><span class="op">)</span> <span class="op">[]</span>A <span class="op">{</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    rs <span class="op">:=</span> <span class="bu">make</span><span class="op">([]</span>A<span class="op">,</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> _<span class="op">,</span> x <span class="op">:=</span> <span class="kw">range</span> xs <span class="op">{</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> fn<span class="op">(</span>x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>            rs <span class="op">=</span> <span class="bu">append</span><span class="op">(</span>rs<span class="op">,</span> x<span class="op">)</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> rs</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>And we can template-ize that as:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="op">{{</span> $m<span class="op">.</span>Alias <span class="op">}}</span> <span class="op">[]{{</span> $m<span class="op">.</span>Receiver <span class="op">}}</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>xs <span class="op">{{</span> $m<span class="op">.</span>Alias <span class="op">}})</span> Filter<span class="op">(</span>fn <span class="kw">func</span><span class="op">({{</span> $m<span class="op">.</span>Receiver <span class="op">}})</span> <span class="dt">bool</span><span class="op">)</span> <span class="op">[]{{</span> $m<span class="op">.</span>Receiver <span class="op">}}</span> <span class="op">{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        rs <span class="op">:=</span> <span class="bu">make</span><span class="op">([]{{</span> $m<span class="op">.</span>Receiver <span class="op">}},</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> _<span class="op">,</span> x <span class="op">:=</span> <span class="kw">range</span> xs <span class="op">{</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                <span class="kw">if</span> fn<span class="op">(</span>x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                        rs <span class="op">=</span> <span class="bu">append</span><span class="op">(</span>rs<span class="op">,</span> x<span class="op">)</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> rs</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>So now when you run your generate statement you should get the
following in <code>pkg/mytypes/demo_fns.go</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Code generated by go; DO NOT EDIT.</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Generated 2021-11-12 16:28:41.742174392 -0800 PST m=+0.000470763</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Functional receivers for Demo</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">// With types [string int]</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> mytypes</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Demos <span class="op">[]</span>Demo</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>xs Demos<span class="op">)</span> Filter<span class="op">(</span>fn <span class="kw">func</span><span class="op">(</span>Demo<span class="op">)</span> <span class="dt">bool</span><span class="op">)</span> <span class="op">[]</span>Demo <span class="op">{</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        rs <span class="op">:=</span> <span class="bu">make</span><span class="op">([]</span>Demo<span class="op">,</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> _<span class="op">,</span> x <span class="op">:=</span> <span class="kw">range</span> xs <span class="op">{</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>                <span class="kw">if</span> fn<span class="op">(</span>x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>                        rs <span class="op">=</span> <span class="bu">append</span><span class="op">(</span>rs<span class="op">,</span> x<span class="op">)</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> rs</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Now, wherever <code>Demo</code>s are used you can do a quick
<code>demos.Filter(func (d Demo) { return d.Num &gt; 3 })</code> to get
all of your objects where the number is greater than three. In your own
version you might even change the return type so that
<code>.Filter</code> becomes chainable with some other stuff down the
line.</p>
<h3 id="map">Map</h3>
<p>Map gets a little sticky. The return type is usually known to the
programmer but go's compiler needs to know. This is where all that wonky
stuff we did in the generator's <code>main</code> comes in handy. We can
tell our generator what it is we <em>really</em> need from a
<code>Map</code>.</p>
<p>Our ideal <code>Map</code> might look something like:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>xs Demos<span class="op">)</span> MapString<span class="op">(</span>fn <span class="kw">func</span><span class="op">(</span>Demo<span class="op">)</span> <span class="dt">string</span><span class="op">)</span> <span class="op">[]</span><span class="dt">string</span> <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    rs <span class="op">:=</span> <span class="bu">make</span><span class="op">([]</span><span class="dt">string</span><span class="op">,</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> _<span class="op">,</span> x <span class="op">:=</span> <span class="kw">range</span> xs <span class="op">{</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        rs <span class="op">=</span> <span class="bu">append</span><span class="op">(</span>rs<span class="op">,</span> fn<span class="op">(</span>x<span class="op">))</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> rs</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Jeez, what a beaut.</p>
<p>To template that we need to be able to loop over whatever types were
requested of the generator and to do that we can use some template
magic:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">{{-</span> <span class="kw">range</span> $t <span class="op">:=</span> $m<span class="op">.</span>Types <span class="op">}}</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>xs <span class="op">{{</span> $m<span class="op">.</span>Alias <span class="op">}})</span> Map<span class="op">{{</span> $t <span class="op">|</span> Title <span class="op">}}(</span>fn <span class="kw">func</span><span class="op">({{</span> $m<span class="op">.</span>Receiver <span class="op">}})</span> <span class="op">{{</span> $t <span class="op">}})</span> <span class="op">[]{{</span> $t <span class="op">}}</span> <span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>        rs <span class="op">:=</span> <span class="bu">make</span><span class="op">([]{{</span> $t <span class="op">}},</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> _<span class="op">,</span> x <span class="op">:=</span> <span class="kw">range</span> xs <span class="op">{</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>                rs <span class="op">=</span> <span class="bu">append</span><span class="op">(</span>rs<span class="op">,</span> fn<span class="op">(</span>x<span class="op">))</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> rs</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="op">{{-</span> end <span class="op">}}</span></span></code></pre></div>
<p>This loops over the types our main parsed and generates
<code>MapString</code> and <code>MapInt</code>. If you need others you
can always go back to your <code>pkg/mytypes/demo.go</code> file and add
the types to your <code>go:generate</code> line. Now when you generate
you'll have two more functions in your package.</p>
<p>So now we have <code>filter</code> and <code>map</code>. Lastly we
need some fold equivalents and we'll generate those in the
<code>mytypes</code> package simply because this is a demo and you
shouldn't be copy and pasting code blindly into your editor.</p>
<h2 id="implementing-folds">Implementing Folds</h2>
<p>So, create another generator file called
<code>pkg/generators/folds.go</code> and let's modify functions
<code>main</code> and <code>gen</code> to look like this:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> gen<span class="op">(</span>pkg <span class="dt">string</span><span class="op">,</span> pairs <span class="op">[][]</span><span class="dt">string</span><span class="op">)</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>        file<span class="op">,</span> err <span class="op">:=</span> os<span class="op">.</span>Create<span class="op">(</span>fmt<span class="op">.</span>Sprintf<span class="op">(</span><span class="st">&quot;%s_folds.go&quot;</span><span class="op">,</span> strings<span class="op">.</span>ToLower<span class="op">(</span>pkg<span class="op">)))</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> err</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">defer</span> file<span class="op">.</span>Close<span class="op">()</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        funcs <span class="op">:=</span> template<span class="op">.</span>FuncMap<span class="op">{</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Title&quot;</span><span class="op">:</span> strings<span class="op">.</span>Title<span class="op">,</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        template<span class="op">.</span>Must<span class="op">(</span>template<span class="op">.</span>New<span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">).</span>Funcs<span class="op">(</span>funcs<span class="op">).</span>Parse<span class="op">(</span>genTemplate<span class="op">)).</span>Execute<span class="op">(</span>file<span class="op">,</span> <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                Package   <span class="dt">string</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>                Pairs     <span class="op">[][]</span><span class="dt">string</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                Timestamp time<span class="op">.</span>Time</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}{</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>                pkg<span class="op">,</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>                pairs<span class="op">,</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>                time<span class="op">.</span>Now<span class="op">(),</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">})</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="ot">nil</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        pkg <span class="op">:=</span> os<span class="op">.</span>Args<span class="op">[</span><span class="dv">1</span><span class="op">]</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        pairs <span class="op">:=</span> <span class="op">[][]</span><span class="dt">string</span><span class="op">{}</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> idx <span class="op">:=</span> <span class="dv">2</span><span class="op">;</span> idx <span class="op">&lt;</span> <span class="bu">len</span><span class="op">(</span>os<span class="op">.</span>Args<span class="op">);</span> idx <span class="op">+=</span> <span class="dv">2</span> <span class="op">{</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>                pairs <span class="op">=</span> <span class="bu">append</span><span class="op">(</span>pairs<span class="op">,</span> os<span class="op">.</span>Args<span class="op">[</span>idx<span class="op">:</span>idx<span class="op">+</span><span class="dv">2</span><span class="op">])</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        gen<span class="op">(</span>pkg<span class="op">,</span> pairs<span class="op">)</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Our fold generator is going to take a list of type pairs we need
folds for and generate those. So if we give the generator
<code>string int</code> we'll get folds where our accumulator and inputs
are of types <code>string int</code> respectively.</p>
<p>In our template we'll modify the non boilerplate comments with the
following bit of cuteness:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="op">{{</span> <span class="kw">range</span> $t <span class="op">:=</span> $m<span class="op">.</span>Pairs <span class="op">}}</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> Foldl<span class="op">{{</span> index $t <span class="dv">0</span> <span class="op">|</span> Title <span class="op">}}{{</span> index $t <span class="dv">1</span> <span class="op">|</span> Title <span class="op">}}(</span>fn <span class="kw">func</span><span class="op">(</span>a <span class="op">{{</span> index $t <span class="dv">0</span> <span class="op">}},</span> b <span class="op">{{</span> index $t <span class="dv">1</span> <span class="op">}})</span> <span class="op">{{</span> index $t <span class="dv">0</span> <span class="op">}},</span> acc <span class="op">{{</span> index $t <span class="dv">0</span> <span class="op">}},</span> is <span class="op">[]{{</span> index $t <span class="dv">1</span> <span class="op">}})</span> <span class="op">{{</span> index $t <span class="dv">0</span> <span class="op">}}</span> <span class="op">{</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>        res <span class="op">:=</span> acc</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> i <span class="op">:=</span> <span class="kw">range</span> is <span class="op">{</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                res <span class="op">=</span> fn<span class="op">(</span>res<span class="op">,</span> <span class="bu">len</span><span class="op">(</span>is<span class="op">)</span> <span class="op">-</span> <span class="dv">1</span> <span class="op">-</span> i<span class="op">)</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> res</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> Foldr<span class="op">{{</span> index $t <span class="dv">0</span> <span class="op">|</span> Title <span class="op">}}{{</span> index $t <span class="dv">1</span> <span class="op">|</span> Title <span class="op">}}(</span>fn <span class="kw">func</span><span class="op">(</span>a <span class="op">{{</span> index $t <span class="dv">0</span> <span class="op">}},</span> b <span class="kw">func</span><span class="op">()</span> <span class="op">{{</span> index $t <span class="dv">1</span> <span class="op">}})</span> <span class="op">{{</span> index $t <span class="dv">0</span> <span class="op">}},</span> acc <span class="op">{{</span> index $t <span class="dv">0</span> <span class="op">}},</span> is <span class="op">[]{{</span> index $t <span class="dv">1</span> <span class="op">}})</span> <span class="op">{{</span> index $t <span class="dv">0</span> <span class="op">}}</span> <span class="op">{</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        res <span class="op">:=</span> acc</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> idx <span class="op">:=</span> <span class="dv">0</span><span class="op">;</span> idx <span class="op">&lt;</span> <span class="bu">len</span><span class="op">(</span>is<span class="op">);</span> idx<span class="op">++</span> <span class="op">{</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>                called <span class="op">:=</span> <span class="ot">false</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>                lambda <span class="op">:=</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{{</span> index $t <span class="dv">1</span> <span class="op">}}</span> <span class="op">{</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>                        called <span class="op">=</span> <span class="ot">true</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">return</span> is<span class="op">[</span>idx<span class="op">]</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>                res <span class="op">=</span> fn<span class="op">(</span>res<span class="op">,</span> lambda<span class="op">)</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>                <span class="kw">if</span> <span class="op">!</span>called <span class="op">{</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">return</span> res</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> res</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="op">{{-</span> end <span class="op">}}</span></span></code></pre></div>
<p>With the input tuple <code>string, int</code> this template will
generate <code>FoldlStringInt</code> and <code>FoldrStringInt</code>.
Now we're having some real fun.</p>
<p>Now we can add
<code>//go:generate go run ../generators/folds.go mytypes int int</code>
to <code>pkg/mytypes/demo.go</code>, run the generator, and then you can
view the very excellent generated code in
<code>pkg/mytypes/mytypes_folds.go</code>:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Code generated by go; DO NOT EDIT.</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Generated 2021-11-12 16:52:05.48205752 -0800 PST m=+0.000807965</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Functional folds for mytypes</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Pairs:</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">// int - int</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> mytypes</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> FoldlIntInt<span class="op">(</span>fn <span class="kw">func</span><span class="op">(</span>a <span class="dt">int</span><span class="op">,</span> b <span class="dt">int</span><span class="op">)</span> <span class="dt">int</span><span class="op">,</span> acc <span class="dt">int</span><span class="op">,</span> is <span class="op">[]</span><span class="dt">int</span><span class="op">)</span> <span class="dt">int</span> <span class="op">{</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        res <span class="op">:=</span> acc</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> i <span class="op">:=</span> <span class="kw">range</span> is <span class="op">{</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>                res <span class="op">=</span> fn<span class="op">(</span>res<span class="op">,</span> <span class="bu">len</span><span class="op">(</span>is<span class="op">)</span> <span class="op">-</span> <span class="dv">1</span> <span class="op">-</span> i<span class="op">)</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> res</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> FoldrIntInt<span class="op">(</span>fn <span class="kw">func</span><span class="op">(</span>a <span class="dt">int</span><span class="op">,</span> b <span class="kw">func</span><span class="op">()</span> <span class="dt">int</span><span class="op">)</span> <span class="dt">int</span><span class="op">,</span> acc <span class="dt">int</span><span class="op">,</span> is <span class="op">[]</span><span class="dt">int</span><span class="op">)</span> <span class="dt">int</span> <span class="op">{</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        res <span class="op">:=</span> acc</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> idx <span class="op">:=</span> <span class="dv">0</span><span class="op">;</span> idx <span class="op">&lt;</span> <span class="bu">len</span><span class="op">(</span>is<span class="op">);</span> idx<span class="op">++</span> <span class="op">{</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>                called <span class="op">:=</span> <span class="ot">false</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>                lambda <span class="op">:=</span> <span class="kw">func</span><span class="op">()</span> <span class="dt">int</span> <span class="op">{</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>                        called <span class="op">=</span> <span class="ot">true</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">return</span> is<span class="op">[</span>idx<span class="op">]</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>                res <span class="op">=</span> fn<span class="op">(</span>res<span class="op">,</span> lambda<span class="op">)</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>                <span class="kw">if</span> <span class="op">!</span>called <span class="op">{</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">return</span> res</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> res</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Boom.</p>
<p>Wait just a gosh dang minute. Why's that <code>foldr</code> look so
weird? Well, short story is that in Haskell and similarly implemented
languages, <code>foldr</code> will thunk the <em>right</em> value and
only continue if that value is requested and in that way you can
prematurely terminate a right fold. A left fold will not happen as the
fold is evaluated <em>from the left</em>. This is a confusing thing if
you're not already familiar with it but the basics are that
<code>foldl + [1 2 3] -&gt; (1 + (2 + 3))</code> and thus cannot short
circuit. Conversely, <code>foldr + [1 2 3] -&gt; (3 + (2 + (1)))</code>
and if you notice the 1 in its own parens then you'll notice that the
<code>+</code> is only done if the <em>next</em> value is evaluated.</p>
<p>Okay, now boom slam.</p>
<p>That's all for today!</p>


    </div>
    <div id="footer">
      <h6>// social twitter:<a href="https://twitter.com/oynoto">@oynoto</a>, patreon:<a href="https://www.patreon.com/oynot">@oynot</a>, github:<a href="https://github.com/tony-o">tony-o</a></h6>
    </div>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
    <script src="/s/hljs-raku.js"></script>
    <script>
      hljs.registerLanguage("raku", hljs_raku);
      (function(){
        languages = {}
        pres      = document.getElementsByTagName("pre");
        for(i = 0; i < hljs.listLanguages().length; i++){
          languages['language-' + hljs.listLanguages()[i]] = 1;
        }
        for(i = 0; i < pres.length; i++){
          pre = pres[i];
          cn  = 'language-plaintext';
          ls  = (pre.getAttribute("class") || 'plaintext').split(' ');
          for(j = 0; j < ls.length; j++){
            if(languages['language-' + ls[j]]){
              cn = 'language-' + ls[j];
              break;
            }
          }
          codes = pre.getElementsByTagName("code")
          for(j = 0; j < codes.length; j++){
            codes[j].setAttribute("class", (codes[j].getAttribute("class") + " hljs " + cn).trim())
          }
        }
        hljs.highlightAll();
      })();
    </script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FKJQZPJ2XK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-FKJQZPJ2XK');
    </script>

  </body>
</html>
